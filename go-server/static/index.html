<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>GrapesJS Scroll Plugin</title>
    <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://unpkg.com/grapesjs-tui-image-editor"></script>
    <script src="https://unpkg.com/grapesjs-blocks-basic"></script>
    <script src="https://unpkg.com/grapesjs-blocks-flexbox"></script>
    <script src="https://unpkg.com/grapesjs-plugin-export"></script>
    <script src="https://unpkg.com/grapesjs-navbar"></script>
    <script src="https://unpkg.com/grapesjs-component-countdown"></script>
    <script src="https://unpkg.com/grapesjs-plugin-forms"></script>
    <script src="https://unpkg.com/grapesjs-tabs"></script>
    <script src="https://unpkg.com/grapesjs-plugin-scroll"></script>
    <script src="https://unpkg.com/grapesjs-plugin-chartjs"></script>
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
        }
    </style>
</head>

<body>

    <div id="gjs" style="height:0px; overflow:hidden">
        <div style="margin:100px 100px 25px; padding:25px; font:caption">
            <p>Welcome to a web editor built with GrapesJS.</p>
            <p> To get started, start by dragging blocks in from the block
                manager in the top right corner. Styles can be edited by clicking on the paintbrush icon and selecting
                the element you wish to edit. For component-specific configurations (such as the charts data), select
                the gears icon. To save, you will need to log in.
            </p>
            <p>
                For more information on this project, check out the repo for <a
                    href="https://github.com/benjgrad/go-server">go-server</a>, and for more details on the editor,
                please visit <a href="https://github.com/benjgrad/www-resume">www-resume</a>, which takes advantage of
                <a href="https://github.com/benjgrad/grapesjs-plugin-scroll">grapesjs-plugin-scroll</a> and <a
                    href="https://github.com/benjgrad/grapesjs-plugin-chartjs">grapesjs-plugin-chartjs</a>.
            </p>
            <p>
                Since user signup currently is not supported, you can use Username: guest and Password: public.
            </p>
        </div>
    </div>
    <dialog id="loginDialog">
        <form method="POST" action="/login">
            <h3>Login</h3>
            <!-- TODO submit this using the fetch API, and handle the response -->
            <form method="POST" action="/login">
                <p><label>Username</label><input name="username" type="text" value="" /></p>
                <p><label>Password</label><input name="password" type="password" value="" /></p>
                <input type="submit" id="loginBtn" value="Login" />
            </form>
        </form>
    </dialog>
    <dialog id="logoutDialog">
        <h3>Logout</h3>
        <input type="button" id="logoutCancelBtn" value="Cancel" />
        <input type="button" value="Logout" id="logoutBtn" />
    </dialog>


    <script type="text/javascript">


        const loginDialog = document.getElementById('loginDialog');
        const logoutDialog = document.getElementById('logoutDialog');
        const username = loginDialog.querySelector('#username');
        const password = loginDialog.querySelector('#password');
        const loginBtn = loginDialog.querySelector('#loginBtn');
        const logoutBtn = logoutDialog.querySelector('#logoutBtn');
        const logoutCancelBtn = logoutDialog.querySelector('#logoutCancelBtn');

        // If a browser doesn't support the dialog, then hide the
        // dialog contents by default.
        if (typeof loginDialog.showModal !== 'function') {
            loginDialog.hidden = true;
            /* a fallback script to allow this dialog/form to function
               for legacy browsers that do not support <dialog>
               could be provided here.
            */
        }
        if (typeof logoutDialog.showModal !== 'function') {
            logoutDialog.hidden = true;
            /* a fallback script to allow this dialog/form to function
               for legacy browsers that do not support <dialog>
               could be provided here.
            */
        }
        // "Confirm" button of form triggers "close" on dialog because of [method="dialog"]
        loginDialog.addEventListener('close', () => {
            // console.log("close");
        });
        logoutCancelBtn.addEventListener('click', () => {
            logoutDialog.close();
        });

        logoutBtn.addEventListener('click', () => {
            fetch("/logout", {
                method: "GET"
            });
            logoutDialog.close();
            location.reload();
        })


        const editor = grapesjs.init({
            container: '#gjs',
            // Get the content for the canvas directly from the element
            // As an alternative we could use: `components: '<h1>Hello World Component!</h1>'`,
            storageManager: {
                type: 'remote', // Storage type. Available: local | remote
                autosave: false, // Store data automatically
                autoload: true, // Autoload stored data on init
                recovery: true,
                // Default storage options
                options: {
                    remote: {
                        urlStore: '/page',
                        urlLoad: '/page',
                        onStore: (data) => ({ data: JSON.stringify(data) }),

                    },
                    local: { key: `gjsProject-${window.location.pathname}` },
                },
            },
            fromElement: true,
            height: "100vh",
            plugins: [
                'grapesjs-tui-image-editor',
                'gjs-blocks-basic',
                'gjs-blocks-flexbox',
                'grapesjs-plugin-export',
                'grapesjs-navbar',
                'grapesjs-component-countdown',
                'grapesjs-plugin-forms',
                'grapesjs-tabs',
                'grapesjs-plugin-scroll',
                'grapesjs-plugin-chartjs',
            ],
            pluginsOpts: {
                'grapesjs-tui-image-editor': {
                    config: {
                        includeUI: {
                            initMenu: 'filter',
                        },
                    },
                    icons: {
                        'menu.normalIcon.path': './icons/icon-d.svg',
                        'menu.activeIcon.path': './icons/icon-b.svg',
                        'menu.disabledIcon.path': './icons.icon-a.svg',
                        'menu.hoverIcon.path': './icons/icon-c.svg',
                        'submenu.normalIcon.path': './icons/icon-d.svg',
                        'submenu.activeIcon.path': './icons/icon-c.svg',
                    },
                }
            },
        });

        editor.Panels.addButton('options', [
            {
                id: 'save-database',
                className: 'fa fa-floppy-o',
                command: 'save-db',
                attributes: {
                    title: 'Save'
                }
            }]);
        editor.Panels.addButton('options', [
            {
                id: 'save-database',
                className: 'fa fa-user',
                command: 'login',
                attributes: {
                    title: 'Login'
                }
            }]);

        editor.Commands.add('save-db', {
            run: function (editor, sender) {
                sender && sender.set('active', 0); // turn off the button

                fetch("/user/status", {
                    method: "GET"
                }).then(res => {
                    if (res.ok) {
                        editor.store();
                    }
                    else {
                        loginDialog.showModal();
                    }
                });

            }
        });
        editor.Commands.add('login', {
            run: function (editor, sender) {
                sender && sender.set('active', 0); // turn off the button

                fetch("/user/status", {
                    method: "GET"
                }).then(res => {
                    if (res.ok) {
                        logoutDialog.showModal();
                    }
                    else {
                        loginDialog.showModal();
                    }
                });

            }
        });

        window.editor = editor;

    </script>
</body>

</html>